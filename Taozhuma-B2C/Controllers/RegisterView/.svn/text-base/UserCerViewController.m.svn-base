//
//  UserInfoViewController.m
//  MailWorldClient
//
//  Created by liyoro on 13-11-3.
//  Copyright (c) 2013年 liyoro. All rights reserved.
//

#import "UserInfoViewController.h"
#import "ELCAssetTablePicker.h"
#import "MailSettingViewController.h"

#import "UserInformation.h"
#import <QuartzCore/QuartzCore.h>

@interface UserInfoViewController () <UITextFieldDelegate, UIActionSheetDelegate> {
    
    UIDatePicker *datePicker;
    NSLocale *datelocale;
    UIActionSheet *sheet;
     NSArray *provinces, *cities, *areas;
}

@property (nonatomic, strong) ALAssetsLibrary *specialLibrary;
@property (nonatomic, strong) UIImage *selectHeadImage;
@property (nonatomic, strong) NSString *selectsex;

@end

@implementation UserInfoViewController
@synthesize proid;
@synthesize fieldEmail;
@synthesize fieldTelephone;
@synthesize fieldFaxl;
@synthesize fieldProvinceId;
@synthesize fieldAddress;
@synthesize fieldMainProducts;
@synthesize btnEE;
@synthesize contentView;
@synthesize headImage;
@synthesize btnBoy;
@synthesize btnGirl;
@synthesize fieldName;
@synthesize fieldBirth;
@synthesize selectsex;
@synthesize selectHeadImage;
@synthesize type;
@synthesize uid;
@synthesize type_business;
- (void) regSuccess {
    MailSettingViewController *storeView = [[MailSettingViewController alloc]init];
    //PasswordViewController *storeView = [[PasswordViewController alloc]init];
    
    //storeView.title = @"新品展示";
    storeView.hidesBottomBarWhenPushed = YES;
    [self.navigationController pushViewController:storeView animated:YES];
//    if (self.type == 1) {
//        [[AppDelegate sharedAppDelegate]loadMainView];
//    }
//    else {
//        [self.navigationController popViewControllerAnimated:YES];
//    }
}

- (void) successed {
//    [[AppDelegate sharedAppDelegate]loadMainView];
    [self.navigationController popViewControllerAnimated:YES];
}

- (IBAction)sexClick:(id)sender {
    UIButton *btn = (UIButton*)sender;
    int tag = btn.tag;
    
    if (tag == 1) {//男
        self.selectsex = @"male";
//        [self.btnBoy setBackgroundColor:[UIColor colorWithRed:0.713726 green:0.713726 blue:0.713726 alpha:1]];//灰
//        [self.btnGirl setBackgroundColor:[UIColor colorWithRed:1.000000 green:0.215686 blue:0.333333 alpha:1]];//红
    
        [self.btnBoy setBackgroundColor:[UIColor colorWithRed:0.000000 green:0.619608 blue:0.878431 alpha:1]];//蓝
        [self.btnGirl setBackgroundColor:[UIColor colorWithRed:0.713726 green:0.713726 blue:0.713726 alpha:1]];//灰
    }
    else {
        self.selectsex = @"female";
//        [self.btnBoy setBackgroundColor:[UIColor colorWithRed:0.000000 green:0.619608 blue:0.878431 alpha:1]];//蓝
//        [self.btnGirl setBackgroundColor:[UIColor colorWithRed:0.713726 green:0.713726 blue:0.713726 alpha:1]];//灰
        
        [self.btnBoy setBackgroundColor:[UIColor colorWithRed:0.713726 green:0.713726 blue:0.713726 alpha:1]];//灰
        [self.btnGirl setBackgroundColor:[UIColor colorWithRed:1.000000 green:0.215686 blue:0.333333 alpha:1]];//红
    }
}

- (IBAction)chooseImage:(id)sender {
    
    // 判断是否支持相机
    if([UIImagePickerController isSourceTypeAvailable:UIImagePickerControllerSourceTypeCamera]) {
        sheet  = [[UIActionSheet alloc] initWithTitle:@"选择头像" delegate:self cancelButtonTitle:@"取消" destructiveButtonTitle:nil otherButtonTitles:@"拍照", @"从相册选择", nil];
    }
    else {
        sheet = [[UIActionSheet alloc] initWithTitle:@"选择头像" delegate:self cancelButtonTitle:@"取消" destructiveButtonTitle:nil otherButtonTitles:@"从相册选择", nil];
    }
    
    sheet.tag = 255;
    
    [sheet showInView:self.view];
}

- (IBAction)pickImage:(id)sender {
    ALAssetsLibrary *library = [[ALAssetsLibrary alloc] init];
    self.specialLibrary = library;
    
    NSMutableArray *groups = [NSMutableArray array];
    [_specialLibrary enumerateGroupsWithTypes:ALAssetsGroupSavedPhotos usingBlock:^(ALAssetsGroup *group, BOOL *stop) {
        if (group) {
            [groups addObject:group];
        } else {
            // this is the end
            [self displayPickerForGroup:[groups objectAtIndex:0]];
        }
    } failureBlock:^(NSError *error) {
        UIAlertView * alert = [[UIAlertView alloc] initWithTitle:@"Error" message:[NSString stringWithFormat:@"Album Error: %@ - %@", [error localizedDescription], [error localizedRecoverySuggestion]] delegate:nil cancelButtonTitle:@"Ok" otherButtonTitles:nil];
        [alert show];
        
        NSLog(@"A problem occured %@", [error description]);
        // an error here means that the asset groups were inaccessable.
        // Maybe the user or system preferences refused access.
    }];
}

- (void)displayPickerForGroup:(ALAssetsGroup *)group {
	ELCAssetTablePicker *tablePicker = [[ELCAssetTablePicker alloc] initWithNibName: nil bundle: nil];
    tablePicker.singleSelection = YES;
    tablePicker.immediateReturn = YES;
    
	ELCImagePickerController *elcPicker = [[ELCImagePickerController alloc] initWithRootViewController:tablePicker];
    elcPicker.maximumImagesCount = 1;
    elcPicker.delegate = self;
	tablePicker.parent = elcPicker;
    
    // Move me
    tablePicker.assetGroup = group;
    [tablePicker.assetGroup setAssetsFilter:[ALAssetsFilter allAssets]];
    
    [self presentViewController:elcPicker animated:YES completion:nil];
}

- (IBAction)infosubmit:(id)sender {
    NSString *name = self.fieldName.text;
    NSString *birth = self.fieldBirth.text;
        NSString *act = @"";
    if (self.type == 1) {
         act = @"add";
        
    }else{
          act = @"edit";
    }

       // NSString *fieldProvinceId = self.fieldProvinceId.text;
     DLog(@"%d",  proid);
         NSString *provid=    [NSString stringWithFormat: @"%d", proid];
    //NSString *provid=[NSString stringWithFormat: @"%d", proid];
  //  NSString *DFDF=[NSString stringWithFormat:(@"%@"),proid];
  


    name = name.length>0?name:@"";
    birth = birth.length>0?birth:@"";
    self.selectsex = self.selectsex.length>0?self.selectsex:@"male";
    
    [self.fieldName resignFirstResponder];
    [self.fieldBirth resignFirstResponder];
    if (name.length == 0) {
        MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
        hud.mode = MBProgressHUDModeText;
        hud.detailsLabelText = @"活动名称不能为空！";
        hud.detailsLabelFont = [UIFont boldSystemFontOfSize:16];
        hud.yOffset = -50.f;
        hud.removeFromSuperViewOnHide = YES;
        [hud hide:YES afterDelay:2];
        return;
    }
    if (birth.length == 0) {
        MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
        hud.mode = MBProgressHUDModeText;
        hud.detailsLabelText = @"活动名称不能为空！";
        hud.detailsLabelFont = [UIFont boldSystemFontOfSize:16];
        hud.yOffset = -50.f;
        hud.removeFromSuperViewOnHide = YES;
        [hud hide:YES afterDelay:2];
        return;
    }
    if (self.fieldEmail.text.length == 0) {
        MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
        hud.mode = MBProgressHUDModeText;
        hud.detailsLabelText = @"活动名称不能为空！";
        hud.detailsLabelFont = [UIFont boldSystemFontOfSize:16];
        hud.yOffset = -50.f;
        hud.removeFromSuperViewOnHide = YES;
        [hud hide:YES afterDelay:2];
        return;
    }
    if (self.fieldTelephone.text.length == 0) {
        MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
        hud.mode = MBProgressHUDModeText;
        hud.detailsLabelText = @"活动名称不能为空！";
        hud.detailsLabelFont = [UIFont boldSystemFontOfSize:16];
        hud.yOffset = -50.f;
        hud.removeFromSuperViewOnHide = YES;
        [hud hide:YES afterDelay:2];
        return;
    }
    if (self.fieldProvinceId.text.length == 0) {
        MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
        hud.mode = MBProgressHUDModeText;
        hud.detailsLabelText = @"活动名称不能为空！";
        hud.detailsLabelFont = [UIFont boldSystemFontOfSize:16];
        hud.yOffset = -50.f;
        hud.removeFromSuperViewOnHide = YES;
        [hud hide:YES afterDelay:2];
        return;
    }
    if (self.fieldAddress.text.length == 0) {
        MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
        hud.mode = MBProgressHUDModeText;
        hud.detailsLabelText = @"活动名称不能为空！";
        hud.detailsLabelFont = [UIFont boldSystemFontOfSize:16];
        hud.yOffset = -50.f;
        hud.removeFromSuperViewOnHide = YES;
        [hud hide:YES afterDelay:2];
        return;
    }
    NSData *imageToUpload = nil;
    NSDictionary *dic;
    if (self.selectHeadImage != nil) {
        UIImage *tempImage = [self resize:CGSizeMake(200, 200)];
        imageToUpload = UIImageJPEGRepresentation(tempImage, 0.5);
        dic = [[NSDictionary alloc]initWithObjectsAndKeys:
              act,                    @"act",
              [Tools stringForKey:KEY_SEX],                    @"type",
                [Tools stringForKey:KEY_USER_ID],                    @"uid",
                self.fieldEmail.text,                    @"email",
           
           self.fieldTelephone.text,                    @"telephone",
        self.fieldFaxl.text,                    @"fax",
              provid,                    @"provinceId",
                 self.fieldAddress.text,                    @"address",
                 self.fieldMainProducts.text,                    @"mainProducts",
               [Tools stringForKey:KEY_USER_ID],  @"userid",
               name,                              @"enterpriseName",
                self.selectsex,                             @"sex",
               birth,                             @"contactor",
               
               nil];
        DLog(@"%@;%@;%@", name, birth, self.selectsex);
        HUD = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
        HUD.delegate = self;
        HUD.labelText = @"资料提交中...";
        [HUD show:YES];
        
        AFHTTPClient *client= [AFHTTPClient clientWithBaseURL:[NSURL URLWithString:SERVICE_URL]];
        [client setParameterEncoding:AFJSONParameterEncoding];
        
          NSString *str2 = @"http://app.toyinjoy.com/api/user_info.php?";
        NSMutableURLRequest *request = [client multipartFormRequestWithMethod:@"POST" path:str2 parameters:dic constructingBodyWithBlock: ^(id <AFMultipartFormData>formData) {
            if (imageToUpload != nil) {
                [formData appendPartWithFileData:imageToUpload name:@"logo" fileName:@"my_head_img.jpg"  mimeType:@"application/octet-stream"];
            }
        }];
        [request setTimeoutInterval:10];
        
        AFHTTPRequestOperation *operation = [[AFHTTPRequestOperation alloc] initWithRequest:request];
        
        [operation setCompletionBlockWithSuccess:^(AFHTTPRequestOperation *operation, id responseObject) {
            NSError* error;
            NSDictionary *json = [NSJSONSerialization JSONObjectWithData:[operation responseData] options:kNilOptions error:&error];
            
            DLog(@"responseObject:%@", json);
            int result = [[json valueForKey:@"result"]integerValue];
            
            if (result == 0) {
                [HUD removeFromSuperview];
                MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
                hud.mode = MBProgressHUDModeText;
                hud.labelText = @"资料提交失败";
                hud.yOffset = -50.f;
                hud.removeFromSuperViewOnHide = YES;
                [hud hide:YES afterDelay:2];
            }
            else {
                [HUD removeFromSuperview];
                MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
                hud.mode = MBProgressHUDModeText;
                hud.labelText = @"资料提交成功";
                hud.yOffset = -50.f;
                hud.removeFromSuperViewOnHide = YES;
                [hud hide:YES afterDelay:2];
                
                UserInformation *tempDto = [[UserInformation alloc]initWithAttributes:[json valueForKey:@"data"]];
                [Tools saveObject:tempDto.username forKey:KEY_USER_NAME];
                [Tools saveObject:tempDto.usermobile forKey:KEY_USER_PHONE];
                [Tools saveObject:tempDto.usersex forKey:KEY_SEX];
                [Tools saveObject:tempDto.userheadimg forKey:KEY_HEADIMG];
                //来源 1：门店 2：猫屋会员
                [Tools saveInteger:tempDto.userfrom forKey:KEY_USERFROM];
                //                [Tools saveObject:tempDto.shopid forKey:KEY_SHOPID];
                [Tools saveObject:tempDto.userbirth forKey:KEY_BIRTH];
                [Tools saveObject:tempDto.age forKey:KEY_AGE];
                [Tools saveObject:tempDto.userbgimg forKey:KEY_BGIMG];
                
                [self performSelector:@selector(regSuccess) withObject:nil afterDelay:2];
            }
            
        } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
            if (error) {
                [HUD removeFromSuperview];
                MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
                hud.mode = MBProgressHUDModeText;
                hud.labelText = @"资料提交失败，请重试";
                hud.yOffset = -50.f;
                hud.removeFromSuperViewOnHide = YES;
                
                [hud hide:YES afterDelay:2];
            }
        }];
        [client enqueueHTTPRequestOperation:operation];
    }
    else {
        DLog(@"%@DD，EE%@",[Tools stringForKey:KEY_SEX],[Tools stringForKey:KEY_USER_ID]);
          //NSString *fieldProvinceIds = self.fieldProvinceId.text;
      //  NSInteger intString = [fieldProvinceIds intValue];
         DLog(@"responseObject:%@",  self.selectsex);
           DLog(@"%d",  proid);
        dic = [[NSDictionary alloc]initWithObjectsAndKeys:
               act,                    @"act",
               [Tools stringForKey:KEY_SEX],                    @"type",
               [Tools stringForKey:KEY_USER_ID],                    @"uid",
               self.fieldEmail.text,                    @"email",
               self.fieldTelephone.text,                    @"telephone",
               self.fieldFaxl.text,                    @"fax",
        provid,                    @"provinceId",
               self.fieldAddress.text,                    @"address",
               self.fieldMainProducts.text,                    @"mainProducts",
               [Tools stringForKey:KEY_USER_ID],  @"userid",
               name,                              @"enterpriseName",
               self.selectsex,                             @"sex",
               birth,                             @"contactor",
               @"",                               @"logo",
               nil];
        
        NSString *xpoint = @"user_info.php?";
        [MailWorldRequest requestWithParams:dic xpoint:xpoint andBlock:^(MailWorldRequest *respond, NSError *error) {
            if (error) {
                [HUD removeFromSuperview];
                MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
                hud.mode = MBProgressHUDModeText;
                hud.labelText = @"资料提交失败，请重试";
                hud.yOffset = -50.f;
                hud.removeFromSuperViewOnHide = YES;
                
                [hud hide:YES afterDelay:2];
            }
            else {
                [HUD removeFromSuperview];
                
                if (respond.result == YES) {
                    MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
                    hud.mode = MBProgressHUDModeText;
                    hud.labelText = @"资料提交成功";
                    hud.yOffset = -50.f;
                    hud.removeFromSuperViewOnHide = YES;
                    
                    [hud hide:YES afterDelay:2];
                    
                    UserInformation *tempDto = [[UserInformation alloc]initWithAttributes:respond.respondData];
                    //                LoginPost *tempDto = [[LoginPost alloc]initWithAttributes:respond.respondData];
                    //                NSString *userid = tempDto.userid;
                    //                [Tools saveObject:userid forKey:KEY_USER_ID];
                    //                [Tools saveBool:YES forKey:KEY_IS_LOGIN];
                    [Tools saveObject:tempDto.username forKey:KEY_USER_NAME];
                    [Tools saveObject:tempDto.usermobile forKey:KEY_USER_PHONE];
                    //[Tools saveObject:tempDto.usersex forKey:KEY_SEX];
                    [Tools saveObject:tempDto.userheadimg forKey:KEY_HEADIMG];
                    //来源 1：门店 2：猫屋会员
                    [Tools saveInteger:tempDto.userfrom forKey:KEY_USERFROM];
                    //                [Tools saveObject:tempDto.shopid forKey:KEY_SHOPID];
                    [Tools saveObject:tempDto.userbirth forKey:KEY_BIRTH];
                    [Tools saveObject:tempDto.age forKey:KEY_AGE];
                    [Tools saveObject:tempDto.userbgimg forKey:KEY_BGIMG];
                      [self performSelector:@selector(regSuccess) withObject:nil afterDelay:2];
                  
                }
                else {
                    MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
                    hud.mode = MBProgressHUDModeText;
                    hud.detailsLabelText = respond.error_msg;
                    hud.detailsLabelFont = [UIFont boldSystemFontOfSize:16];
                    hud.yOffset = -50.f;
                    hud.removeFromSuperViewOnHide = YES;
                    
                    [hud hide:YES afterDelay:2];
                }
            }
        }];
    }
}
//- (void)actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex
//{
//    if (buttonIndex == 0) {
//        //        self.fieldCell8.text = @"美食餐饮";
//        //        serviceType = @"1";
//        type=1024;
//        fieldProvinceId.text=@"生DD产商";
//
//       // typeField.text=@"生产商";
//        //  break;
//    }else if (buttonIndex == 1) {
//        type=256;
//        
//      //  typeField.text=@"采购商";
//    }else if(buttonIndex == 2) {
//        type=128;
//       // typeField.text=@"生产贸易商";
//    }
//    
//}
- (IBAction)viewClick:(id)sender {
  //  NSArray *DFDS=
   sheet  = [[UIActionSheet alloc] initWithTitle:@"选择服务分类" delegate:self cancelButtonTitle:@"取消" destructiveButtonTitle:nil otherButtonTitles:@"北京市", @"天津市", @"上海市", @"重庆市", @"河北省", @"内蒙古", @"辽宁省", @"吉林省", @"黑龙江省", @"江苏省", @"浙江省", @"安徽省", @"福建省", @"江西省", @"山东省", @"山西省", @"河南省", @"湖北省", @"湖南省", @"广东省",@"广西", @"海南省",@"四川省",@"贵州省",@"云南省",@"西藏", @"陕西省",@"甘肃省",@"青海省",@"宁夏",@"新疆",@"台湾",@"香港",@"澳门",nil];
    sheet.actionSheetStyle = UIActionSheetStyleBlackOpaque;

    sheet.tag = 2;
   [sheet showInView:self.view];
    //    UIActionSheet *actionSheet = [[UIActionSheet alloc]
    //                                  initWithTitle:@"title,nil时不显示"
    //                                  delegate:self
    //                                  cancelButtonTitle:@"取消"
    //                                  destructiveButtonTitle:@"确定"
    //                                  otherButtonTitles:@"第一项", @"第二项",nil];
    //actionSheet.actionSheetStyle = UIActionSheetStyleBlackOpaque;
    //[actionSheet showInView:self.view];
}
- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil {
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
    
            if (self.type == 1) {
                  self.title = @"注帐帐户";
            
            }else{
                         self.title = @"我的基本信息";
            }

      
    }
    return self;
}
- (void)loadData {
    HUD = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
    HUD.delegate = self;
    HUD.labelText = @"数据加载中...";
    [HUD show:YES];
    //原网络请求地址
    NSDictionary *dic = [[NSDictionary alloc]initWithObjectsAndKeys:
                         @"edit",     @"act",
                         [Tools stringForKey:KEY_USER_ID],         @"uid",
                           [Tools stringForKey:KEY_SEX],     @"type",
             
                         nil];
    NSLog(@"%@",dic);
    NSString *xpoint = @"user_info.php?";
    [MailWorldRequest requestWithParams:dic xpoint:xpoint andBlock:^(MailWorldRequest *respond, NSError *error) {
        if (error) {
            [HUD removeFromSuperview];
        }
        else {
            if (respond.result == 1) {
                
                
              //  tempDetail = [[ShopDetailEntity alloc]initWithAttributes:respond.respondData];
               // DLog(@"%f", tempDetail.xpoint.doubleValue);
                NSLog(@"requestWithParamsDDD:%@",respond.respondData);
                NSDictionary *temDic = respond.respondData;
                //   NSDictionary *temList = [respond.respondArray objectAtIndex:0];
                   NSLog(@"requestWithParamsDDD:%@",[temDic valueForKey:@"enterpriseName"]);
                self.fieldName.text=[temDic valueForKey:@"enterpriseName"];
                         self.fieldBirth.text=[temDic valueForKey:@"contactor"];
                  self.fieldEmail.text=[temDic valueForKey:@"email"];
                   self.fieldTelephone.text=[temDic valueForKey:@"telephone"];
                 self.fieldFaxl.text=[temDic valueForKey:@"fax"];
                   NSInteger prdoid= [[temDic valueForKey:@"provinceId"] intValue];
                DLog(@"ddd%d",prdoid);
                self.fieldProvinceId.text= [[provinces objectAtIndex:prdoid] objectForKey:@"state"];
                  //self.fieldProvinceId.text=[temDic valueForKey:@"provinceId"];
                 self.fieldAddress.text=[temDic valueForKey:@"address"];
                         self.fieldMainProducts.text=[temDic valueForKey:@"mainProducts"];
              
                    self.headImage.imageUrl = [temDic valueForKey:@"logo"];
             
                
                if ([[temDic valueForKey:@"sex"] isEqualToString:@"male"]) {
                    self.selectsex = @"male";
                    
                    [self.btnBoy setBackgroundColor:[UIColor colorWithRed:0.000000 green:0.619608 blue:0.878431 alpha:1]];//蓝
                    [self.btnGirl setBackgroundColor:[UIColor colorWithRed:0.713726 green:0.713726 blue:0.713726 alpha:1]];//灰
                }
                else {
                    self.selectsex = @"female";
                    [self.btnBoy setBackgroundColor:[UIColor colorWithRed:0.713726 green:0.713726 blue:0.713726 alpha:1]];//灰
                    [self.btnGirl setBackgroundColor:[UIColor colorWithRed:1.000000 green:0.215686 blue:0.333333 alpha:1]];//红
                }

                //  self.fieldQQ.text=[temDic valueForKey:@"fax"];
               // self.prizeName.text= [NSString stringWithFormat:@"%@",[temList valueForKey:@"prizename"]];
                //      NSInteger prizestatu = [[temDic valueForKey:@"prizestatu"]integerValue];
                
//                NSArray *temList = [temDic valueForKey:@"images"];
//                NSArray *attribute = [temDic valueForKey:@"attribute"];
//                
                
                [HUD removeFromSuperview];
              //  [data_ removeAllObjects];
                
                
           
                
//                NSLog(@"ewew:%@",temList);
//                self.labelZhuying.text =[[attribute objectAtIndex:0]valueForKey:@"value"];
//                //NSLog(@"ewewE:%@",[[temList objectAtIndex:0]valueForKey:@"imageName"]);
//                self.shopImage1.imageUrl =[[temList objectAtIndex:0]valueForKey:@"imageName"];
//                // self.shopImage1.imageUrl = [temDic objectAtIndex:0];
//                //  DLog(@"%f", tempDetail.xpoint.doubleValue);
//                lat = tempDetail.xpoint.doubleValue;
//                lng = tempDetail.ypoint.doubleValue;
//                //     self.shopImage1.imageUrl = [[respond.respondArray objectAtIndex:0]valueForKey:@"proImage"]；
//                self.title = tempDetail.shopname;
//                self.shopImage.image = [UIImage imageNamed:@"bg_default"];
//                self.shopImage.imageUrl =[[temList objectAtIndex:0]valueForKey:@"imageName"];
//                self.labelShopName.text = tempDetail.shopname;
//                self.labelZhuying.text = tempDetail.shopzhuying;
//                [self.btnPhone addTarget:self action:@selector(callPhone:) forControlEvents:UIControlEventTouchUpInside];
//                self.labelAdd.text = tempDetail.shopAddress;
//                //                self.labelHuodong.text = tempDetail.ShopActivityContent;
//                self.labelTime.text = tempDetail.shopServeTime;
//                int shopCommentGrade = tempDetail.shopCommentGrade;
//                //   self.ratingView = [[TQStarRatingView alloc] initWithFrame:CGRectMake(108, 35, 21*5+2*4, 21) numberOfStar:5];
//                //    [self.ratingView setScore:shopCommentGrade*0.2 withAnimation:YES];
//                //  self.ratingView.userInteractionEnabled = NO;
//                //  [self.contentView addSubview:self.ratingView];
                
            }
        }
    }];
}

- (void)viewDidLoad {
    [super viewDidLoad];
    provinces = [[NSArray alloc] initWithContentsOfFile:[[NSBundle mainBundle] pathForResource:@"city.plist" ofType:nil]];
   // cities = [[provinces objectAtIndex:0] objectForKey:@"cities"];
   // NSLog(@"%@",[[provinces objectAtIndex:1] objectForKey:@"state"]);
 
   // self.locate.city = [cities objectAtIndex:0];
   //  [Tools saveObject:@"1024" forKey:KEY_SEX];
     // [Tools saveObject:@"8" forKey:KEY_USER_ID];
    UIBarButtonItem *submitBar = [[UIBarButtonItem alloc]initWithTitle:@"完成" style:UIBarButtonItemStyleBordered target:self action:@selector(infosubmit:)];
    self.navigationItem.rightBarButtonItem = submitBar;
    
    //为图片设置边框
    self.headImage.layer.cornerRadius = 6;
    self.headImage.layer.masksToBounds = YES;
    [self.headImage.layer setBorderWidth:2];
    [self.headImage.layer setBorderColor:[[UIColor orangeColor] CGColor]];
    self.headImage.contentMode = UIViewContentModeScaleAspectFill;

    
    [self.fieldName setFrame:CGRectMake(self.fieldName.frame.origin.x, self.fieldName.frame.origin.y, self.fieldName.frame.size.width, 44)];
    [self.fieldBirth setFrame:CGRectMake(self.fieldBirth.frame.origin.x, self.fieldBirth.frame.origin.y, self.fieldBirth.frame.size.width, 44)];
 
    [self.contentView setContentSize:CGSizeMake(320, self.view.frame.size.height+440)];
    
    // 建立 UIDatePicker
   // datePicker = [[UIDatePicker alloc]init];
    // 時區的問題請再找其他協助 不是本篇重點
//    datelocale = [[NSLocale alloc] initWithLocaleIdentifier:@"zh_CN"];
//    datePicker.locale = datelocale;
//    datePicker.timeZone = [NSTimeZone timeZoneWithName:@"Asia/Shanghai"];
//    datePicker.datePickerMode = UIDatePickerModeDate;
    // 以下這行是重點 (螢光筆畫兩行) 將 UITextField 的 inputView 設定成 UIDatePicker
    // 則原本會跳出鍵盤的地方 就改成選日期了
 //   self.fieldBirth.inputView = datePicker;
    
    // 建立 UIToolbar
//    UIToolbar *toolBar = [[UIToolbar alloc]initWithFrame:CGRectMake(0, 0, 320, 44)];
//    toolBar.barStyle = UIBarStyleBlackTranslucent;
//    
//    UIBarButtonItem *cancelButton = [[UIBarButtonItem alloc] initWithTitle:@"取消"
//                                                                     style:UIBarButtonItemStyleBordered
//                                                                    target:self
//                                                                    action:@selector(DatePickerDoneClick:)];
    
//    UIBarButtonItem *spaceBarItem = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemFlexibleSpace
//                                                                                  target:nil
//                                                                                  action:nil];
//    
//    UIBarButtonItem *confirmButton = [[UIBarButtonItem alloc] initWithTitle:@"确定"
//                                                                      style:UIBarButtonItemStyleDone
//                                                                     target:self
//                                                                     action:@selector(DatePickerDoneClick:)];
//    cancelButton.tag = 1;
//    confirmButton.tag = 2;
    
//    [toolBar setItems:[NSArray arrayWithObjects:cancelButton, spaceBarItem,confirmButton, nil]];
    
    
//    // 選取日期完成鈕 並給他一個 selector
//    UIBarButtonItem *right = [[UIBarButtonItem alloc]initWithBarButtonSystemItem:UIBarButtonSystemItemDone target:self
//                                                                          action:@selector(cancelPicker)];
//    // 把按鈕加進 UIToolbar
//    toolBar.items = [NSArray arrayWithObject:right];
    // 以下這行也是重點 (螢光筆畫兩行)
    // 原本應該是鍵盤上方附帶內容的區塊 改成一個 UIToolbar 並加上完成鈕
    
   // self.fieldBirth.inputAccessoryView = toolBar;
    
    if ([Tools stringForKey:KEY_HEADIMG].length>0) {
        self.headImage.imageUrl = [Tools stringForKey:KEY_HEADIMG];
    }
    
       if (self.type == 2) {
      
 
 [self loadData];
    //self.fieldName.text = [Tools stringForKey:KEY_USER_NAME];
   // self.fieldBirth.text = [Tools stringForKey:KEY_BIRTH];
           }
    
}

#pragma mark - UITextFieldDelegate
- (BOOL)textFieldShouldBeginEditing:(UITextField *)textField {
    if (textField == self.fieldName) {
        return YES;
    }
    else  {
        return YES;
    }
    return NO;
}

- (void)DatePickerDoneClick:(id)sender {
    NSInteger tag = ((UIButton*)sender).tag;
    if (tag == 1) {
        [self.fieldBirth resignFirstResponder];
    }
    else {
        [self.fieldBirth resignFirstResponder];
        NSDateFormatter *formatter = [[NSDateFormatter alloc] init];
        NSString *dateFormat = [NSDateFormatter dateFormatFromTemplate:@"yyyy-MM-dd" options:0 locale:datelocale];
        [formatter setDateFormat:dateFormat];
        [formatter setLocale:datelocale];
        // 將選取後的日期 填入 UITextField
        self.fieldBirth.text = [NSString stringWithFormat:@"%@",[formatter stringFromDate:datePicker.date]];
    }
}

#pragma mark ELCImagePickerControllerDelegate Methods

- (void)elcImagePickerController:(ELCImagePickerController *)picker didFinishPickingMediaWithInfo:(NSArray *)info {
    [self dismissViewControllerAnimated:YES completion:nil];
	
    NSMutableArray *images = [NSMutableArray arrayWithCapacity:[info count]];
	
	for(NSDictionary *dict in info) {
        
        UIImage *image = [dict objectForKey:UIImagePickerControllerOriginalImage];
        [images addObject:image];
        
        self.selectHeadImage = image;
        
        UIImage *tempImage = [self resize:CGSizeMake(200, 200)];
        self.headImage.image = tempImage;
	}
}

- (void)elcImagePickerControllerDidCancel:(ELCImagePickerController *)picker {
    [self dismissViewControllerAnimated:YES completion:nil];
}

#pragma mark -UIActionSheetDelegate
- (void) actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex {
  
    //value = [NSNumber numberWithInt:0];
    NSLog(@"@%d",actionSheet.tag);
    if (actionSheet.tag == 255) {
        
        // 判断是否支持相机
        if ([UIImagePickerController isSourceTypeAvailable:UIImagePickerControllerSourceTypeCamera]) {
            
            if (buttonIndex == sheet.cancelButtonIndex) {
                return;
            }
            switch (buttonIndex) {
                case 0: {// 相机
                    UIImagePickerController *imagePickerController = [[UIImagePickerController alloc] init];
                    imagePickerController.delegate = self;
                    imagePickerController.allowsEditing = YES;
                    imagePickerController.sourceType = UIImagePickerControllerSourceTypeCamera;
                    [self presentViewController:imagePickerController animated:YES completion:^{}];
                }
                    break;
                    
                case 1: {// 相册
                    [self pickImage:nil];
                }
                    break;
            }
        }
       else {
            if (buttonIndex == 0) {
                [self pickImage:nil];
            }
        }
        // 跳转到相机或相册页面
    }   else if (actionSheet.tag == 2) {
           proid=buttonIndex+1;
        //@"美食餐饮", @"休闲娱乐", @"丽人", @"生活服务"
        if (buttonIndex == sheet.cancelButtonIndex) {
            return;
        }
  
        switch (buttonIndex) {
                
            case 0:
               self.fieldProvinceId.text = @"北京市";
                //proid=1;
                //serviceType = @"1";
                break;
            case 1:
                self.fieldProvinceId.text = @"天津市";
               //proid=2;
                break;
            case 2:
                self.fieldProvinceId.text = @"上海市";
               
                break;
            case 3:
               // self.fieldCell8.text = @"生活服务";
                 self.fieldProvinceId.text = @"重庆市";
              //  serviceType = @"4";
                break;
            case 4:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"河北省";
                //  serviceType = @"4";
                break;
            case 5:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"内蒙古";
                //  serviceType = @"4";
                break;
            case 6:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"辽宁省";
                //  serviceType = @"4";
                break;
            case 7:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"吉林省";
                //  serviceType = @"4";
                break;
            case 8:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"黑龙江省";
                //  serviceType = @"4";
                break;
            case 9:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"江苏省";
                //  serviceType = @"4";
                break;
            case 10:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"浙江省";
                //  serviceType = @"4";
                break;
            case 11:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"安徽省";
                //  serviceType = @"4";
                break;
            case 12:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"福建省";
                //  serviceType = @"4";
                break;
            case 13:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"江西省";
                //  serviceType = @"4";
                break;
            case 14:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"山东省";
                //  serviceType = @"4";
                break;
            case 15:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"山西省";
                //  serviceType = @"4";
                break;
            case 16:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"河南省";
                //  serviceType = @"4";
                break;
            case 17:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"湖北省";
                //  serviceType = @"4";
                break;
            case 18:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"湖南省";
                //  serviceType = @"4";
                break;
            case 19:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"广东省";
                //  serviceType = @"4";
                break;
            case 20:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"广西";
                //  serviceType = @"4";
                break;
            case 21:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"海南省";
                //  serviceType = @"4";
                break;
            case 22:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"四川省";
                //  serviceType = @"4";
                break;
            case 23:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"贵州省";
                //  serviceType = @"4";
                break;
            case 24:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"云南省";
                //  serviceType = @"4";
                break;
            case 25:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"西藏";
                //  serviceType = @"4";
                break;
            case 26:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"陕西省";
                //  serviceType = @"4";
                break;
            case 27:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"甘肃省";
                //  serviceType = @"4";
                break;
            case 28:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"青海省";
                //  serviceType = @"4";
                break;
            case 29:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"宁夏";
                //  serviceType = @"4";
                break;
            case 30:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"新疆";
                //  serviceType = @"4";
                break;
            case 31:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"台湾";
                //  serviceType = @"4";
                break;
            case 32:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"香港";
                //  serviceType = @"4";
                break;
            case 33:
                // self.fieldCell8.text = @"生活服务";
                self.fieldProvinceId.text = @"澳门";
                //  serviceType = @"4";
                break;
                
            default:
                break;
        }
    }
}

#pragma mark - image pickerdelegte
- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary *)info {
	[picker dismissViewControllerAnimated:YES completion:^{}];
    
    UIImage *image = [info objectForKey:UIImagePickerControllerOriginalImage];
    self.headImage.image = image;
    self.selectHeadImage = image;
}

- (void)imagePickerControllerDidCancel:(UIImagePickerController *)picker {
	[self dismissViewControllerAnimated:YES completion:^{}];
}

- (UIImage *)resize:(CGSize)newSize
{
    CGImageRef imgRef = self.selectHeadImage.CGImage;
    
    CGFloat width = CGImageGetWidth(imgRef);
    CGFloat height = CGImageGetHeight(imgRef);
    
    CGAffineTransform transform = CGAffineTransformIdentity;
    CGRect bounds = CGRectMake(0, 0, width, height);
    if ( width > newSize.width || height > newSize.height )
	{
        CGFloat ratio = width/height;
        if ( ratio > 1 )
		{
            bounds.size.width = newSize.width;
            bounds.size.height = bounds.size.width / ratio;
        }
        else
		{
            bounds.size.height = newSize.height;
            bounds.size.width = bounds.size.height * ratio;
        }
    }
    
    CGFloat scaleRatio = bounds.size.width / width;
    CGSize imageSize = CGSizeMake(CGImageGetWidth(imgRef), CGImageGetHeight(imgRef));
    CGFloat boundHeight;
    UIImageOrientation orient = self.selectHeadImage.imageOrientation;
    switch(orient) {
            
        case UIImageOrientationUp: //EXIF = 1
            transform = CGAffineTransformIdentity;
            break;
            
        case UIImageOrientationUpMirrored: //EXIF = 2
            transform = CGAffineTransformMakeTranslation(imageSize.width, 0.0);
            transform = CGAffineTransformScale(transform, -1.0, 1.0);
            break;
            
        case UIImageOrientationDown: //EXIF = 3
            transform = CGAffineTransformMakeTranslation(imageSize.width, imageSize.height);
            transform = CGAffineTransformRotate(transform, M_PI);
            break;
            
        case UIImageOrientationDownMirrored: //EXIF = 4
            transform = CGAffineTransformMakeTranslation(0.0, imageSize.height);
            transform = CGAffineTransformScale(transform, 1.0, -1.0);
            break;
            
        case UIImageOrientationLeftMirrored: //EXIF = 5
            boundHeight = bounds.size.height;
            bounds.size.height = bounds.size.width;
            bounds.size.width = boundHeight;
            transform = CGAffineTransformMakeTranslation(imageSize.height, imageSize.width);
            transform = CGAffineTransformScale(transform, -1.0, 1.0);
            transform = CGAffineTransformRotate(transform, 3.0 * M_PI / 2.0);
            break;
            
        case UIImageOrientationLeft: //EXIF = 6
            boundHeight = bounds.size.height;
            bounds.size.height = bounds.size.width;
            bounds.size.width = boundHeight;
            transform = CGAffineTransformMakeTranslation(0.0, imageSize.width);
            transform = CGAffineTransformRotate(transform, 3.0 * M_PI / 2.0);
            break;
            
        case UIImageOrientationRightMirrored: //EXIF = 7
            boundHeight = bounds.size.height;
            bounds.size.height = bounds.size.width;
            bounds.size.width = boundHeight;
            transform = CGAffineTransformMakeScale(-1.0, 1.0);
            transform = CGAffineTransformRotate(transform, M_PI / 2.0);
            break;
            
        case UIImageOrientationRight: //EXIF = 8
            boundHeight = bounds.size.height;
            bounds.size.height = bounds.size.width;
            bounds.size.width = boundHeight;
            transform = CGAffineTransformMakeTranslation(imageSize.height, 0.0);
            transform = CGAffineTransformRotate(transform, M_PI / 2.0);
            break;
            
        default:
            [NSException raise:NSInternalInconsistencyException format:@"Invalid image orientation"];
            
    }
    
    UIGraphicsBeginImageContext(bounds.size);
    
    CGContextRef context = UIGraphicsGetCurrentContext();
    
    if ( orient == UIImageOrientationRight || orient == UIImageOrientationLeft )
	{
        CGContextScaleCTM(context, -scaleRatio, scaleRatio);
        CGContextTranslateCTM(context, -height, 0);
    }
    else
	{
        CGContextScaleCTM(context, scaleRatio, -scaleRatio);
        CGContextTranslateCTM(context, 0, -height);
    }
    
    CGContextConcatCTM(context, transform);
    
    CGContextDrawImage(UIGraphicsGetCurrentContext(), CGRectMake(0, 0, width, height), imgRef);
    UIImage * imageCopy = UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();
    
    return imageCopy;
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

@end
